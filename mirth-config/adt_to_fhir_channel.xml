<!-- Note: This is a template. Actual channel must be created and exported from Mirth Administrator -->
<channel version="4.4.1">
  <id>adt-to-fhir-channel</id>
  <name>ADT_to_FHIR_Patient</name>
  <description>Transforms HL7 ADT^A01 messages to FHIR R4 Patient resources via InfoGleam FHIR Service</description>
  
  <sourceConnector version="4.4.1">
    <metaDataId>1</metaDataId>
    <name>HL7 v2.x Listener</name>
    <properties class="com.mirth.connect.connectors.tcp.TcpReceiverProperties" version="4.4.1">
      <listenerConnectorProperties version="4.4.1">
        <host>0.0.0.0</host>
        <port>9001</port>
      </listenerConnectorProperties>
      <transmissionModeProperties class="com.mirth.connect.connectors.tcp.TcpReceiverModeProperties" version="4.4.1">
        <protocolName>MLLP</protocolName>
      </transmissionModeProperties>
      <dataTypeBinary>false</dataTypeBinary>
      <charsetEncoding>UTF-8</charsetEncoding>
    </properties>
    <transformer>
      <elements>
        <com.mirth.connect.plugins.javascriptstep.JavaScriptStep version="4.4.1">
          <name>Extract HL7 Patient Data</name>
          <script>
// Extract patient demographics from HL7 PID segment
var patientId = msg['PID']['PID.3']['PID.3.1'].toString();
var lastName = msg['PID']['PID.5']['PID.5.1'].toString();
var firstName = msg['PID']['PID.5']['PID.5.2'].toString();
var birthDate = msg['PID']['PID.7']['PID.7.1'].toString();
var gender = msg['PID']['PID.8']['PID.8.1'].toString();
var address = msg['PID']['PID.11']['PID.11.1'].toString();
var city = msg['PID']['PID.11']['PID.11.3'].toString();
var zipCode = msg['PID']['PID.11']['PID.11.5'].toString();
var country = msg['PID']['PID.11']['PID.11.6'].toString();
var phone = msg['PID']['PID.13']['PID.13.1'].toString();

// Format birthdate from YYYYMMDD to YYYY-MM-DD
function formatDate(hl7Date) {
    if (hl7Date &amp;&amp; hl7Date.length >= 8) {
        return hl7Date.substring(0, 4) + '-' + 
               hl7Date.substring(4, 6) + '-' + 
               hl7Date.substring(6, 8);
    }
    return null;
}

// Create JSON payload for FHIR service
var payload = {
    patientId: patientId,
    firstName: firstName,
    lastName: lastName,
    gender: gender,
    birthDate: formatDate(birthDate),
    address: address,
    city: city,
    zipCode: zipCode,
    country: country,
    phone: phone
};

channelMap.put('fhirPayload', JSON.stringify(payload));
logger.info('Extracted patient: ' + firstName + ' ' + lastName);
          </script>
        </com.mirth.connect.plugins.javascriptstep.JavaScriptStep>
      </elements>
      <inboundTemplate encoding="base64"></inboundTemplate>
    </transformer>
  </sourceConnector>
  
  <destinationConnectors>
    <connector version="4.4.1">
      <metaDataId>2</metaDataId>
      <name>FHIR Transformation Service</name>
      <properties class="com.mirth.connect.connectors.http.HttpDispatcherProperties" version="4.4.1">
        <host>http://fhir-logic-service:3000/fhir/Patient</host>
        <method>POST</method>
        <headers class="linked-hash-map">
          <entry>
            <string>Content-Type</string>
            <string>application/json</string>
          </entry>
        </headers>
        <useAuthentication>false</useAuthentication>
        <responseContentType>application/json</responseContentType>
        <includeHeadersInResponse>false</includeHeadersInResponse>
        <socketTimeout>30000</socketTimeout>
      </properties>
      <transformer>
        <elements>
          <com.mirth.connect.plugins.mapper.MapperStep version="4.4.1">
            <name>Set Request Body</name>
            <variable>
              <mapping>
                <![CDATA[$('fhirPayload')]]>
              </mapping>
            </variable>
          </com.mirth.connect.plugins.mapper.MapperStep>
        </elements>
        <outboundTemplate encoding="base64"></outboundTemplate>
      </transformer>
    </connector>
  </destinationConnectors>
  
  <properties version="4.4.1">
    <clearGlobalChannelMap>true</clearGlobalChannelMap>
    <messageStorageMode>DEVELOPMENT</messageStorageMode>
    <encryptData>false</encryptData>
    <removeContentOnCompletion>false</removeContentOnCompletion>
    <removeOnlyFilteredOnCompletion>false</removeOnlyFilteredOnCompletion>
    <removeAttachmentsOnCompletion>false</removeAttachmentsOnCompletion>
    <initialState>STARTED</initialState>
    <storeAttachments>false</storeAttachments>
  </properties>
</channel>
